# fork扩展实现逻辑备忘

- api.field{json,bson,file,isn}
- api.server_option{pack,func}
- api.middle_filter{pack,func}
- api.group{path,desc}
- api.group_filter{pack,func}
- api.handle{path,desc,body}
- api.handle_filter{pack,func}
- api.socket{path,desc}
- api.socket_filter{path,func}

## 项目依赖
- 在GOPATH添加github.com/obase/go依赖,主要是api/base.proto及相关元数据依赖

## api.field扩展实现
- json/bsonf支持
    
    修改github.com/golang/protobuf/protoc-gen-go/generator/generator.go
    - func (g *Generator) generateInternalStructFields(mc *msgCtx, topLevelFields []topLevelField)
      ```
        // generateInternalStructFields just adds the XXX_<something> fields to the message struct.
        func (g *Generator) generateInternalStructFields(mc *msgCtx, topLevelFields []topLevelField) {
        	/*---------------START: 支持option field----------------*/
        	g.P("XXX_NoUnkeyedLiteral\tstruct{} `json:\"-\" bson:\"-\"`") // prevent unkeyed struct literals
        	if len(mc.message.ExtensionRange) > 0 {
        		messageset := ""
        		if opts := mc.message.Options; opts != nil && opts.GetMessageSetWireFormat() {
        			messageset = "protobuf_messageset:\"1\" "
        		}
        		g.P(g.Pkg["proto"], ".XXX_InternalExtensions `", messageset, "json:\"-\" bson:\"-\"`")
        	}
        	g.P("XXX_unrecognized\t[]byte `json:\"-\" bson:\"-\"`")
        	g.P("XXX_sizecache\tint32 `json:\"-\" bson:\"-\"`")
        	/*---------------END: 支持option field----------------*/
        }
      ```
      主要是针对自动字段添加bson:"-"支持mongo bson转换忽略此字段. 以此类推!

    - func (g *Generator) generateMessage(message *Descriptor) 
      ```
       //tag := fmt.Sprintf("protobuf:%s json:%q", g.goTag(message, field, wiretype), jsonName+",omitempty")
		/*---------------START: 支持option field----------------*/
		var js, bs string
		fopt, _ := proto.GetExtension(field.Options, x.E_Field)
		switch fopt := fopt.(type) {
		case *x.Field:
			js = fopt.Json
			bs = fopt.Bson
		}
		if js == "" {
			js = jsonName + ",omitempty"
		}
		if bs == "" {
			bs = jsonName
		}
		tag := fmt.Sprintf("protobuf:%s json:%q bson:%q", g.goTag(message, field, wiretype), js, bs)
		/*---------------END: 支持option field----------------*/
      ```
      主要是针对自定义字段添加json与bson的tag支持
      
- file支持

    (TODO)
    
- isn支持

    (TODO)
    
## api.server_option/api.middle_filter支持
    
- 新增github.com/golang/protobuf/protoc-gen-go/apix/apix.go
    - 定义type apix struct用于实现github.com/golang/protobuf/protoc-gen-go/generator.Plugin接口
        ```
        type Plugin interface {
            // Name identifies the plugin.
            Name() string
            // Init is called once after data structures are built but before
            // code generation begins.
            Init(g *Generator)
            // Generate produces the code generated by the plugin for this file,
            // except for the imports, by calling the generator's methods P, In, and Out.
            Generate(file *FileDescriptor)
            // GenerateImports produces the import declarations for this file.
            // It is called after Generate.
            GenerateImports(file *FileDescriptor)
        }
        ```
    - 定义init()用于注册apix
        ```
        package apix
        
        import "github.com/golang/protobuf/protoc-gen-go/generator"
        
        func init() {
        	generator.RegisterPlugin(new(apix))
        }
        
        type apix struct {
        	gen *generator.Generator
        }
        
        // Name returns the name of this plugin, "grpc".
        func (g *apix) Name() string {
        	return "apix"
        }
        
        // Init initializes the plugin.
        func (g *apix) Init(gen *generator.Generator) {
        	g.gen = gen
        }
        
        // GenerateImports generates the import declaration for this file.
        func (g *apix) GenerateImports(file *generator.FileDescriptor) {
        }
        
        // Generate generates code for the services in the given file.
        func (g *apix) Generate(file *generator.FileDescriptor) {
        	
        }
        ```
 - 修改github.com/golang/protobuf/protoc-gen-go/link_grpc.go添加
    ```
    import _ "github.com/golang/protobuf/protoc-gen-go/apix"
    ```
 
 - 重新go build github.com/golang/protobuf/protoc-gen-go并将结果存放到$PATH
 
 完毕!